name: Deploy Logic App Workflows

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      selected_environment:
        type: choice
        description: SELECT ENVIRONMENT
        required: true
        default: TEST
        options: 
        - PROD
        - UAT
        - TEST

jobs:
  build-gh-logic-app:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: .bicep/logicapps
    steps:
      - uses: actions/checkout@v2

      - name: Configuration for PRODUCTION environment
        if: ${{ github.event.inputs.selected_environment == 'PROD' }}
        run: |
          echo "GH_DOMAIN=${{ secrets.GH_DOMAIN_PROD }}" >> $GITHUB_ENV
          echo "ACTIVE_ENV=PROD" >> $GITHUB_ENV

      - name: Configuration for UAT environment
        if: ${{ github.event.inputs.selected_environment == 'UAT' }}
        run: |
          echo "GH_DOMAIN=${{ secrets.GH_DOMAIN_UAT }}" >> $GITHUB_ENV
          echo "ACTIVE_ENV=UAT" >> $GITHUB_ENV

      - name: Configuration for TEST environment
        if: ${{ github.event.inputs.selected_environment == 'TEST' }}
        run: |
          echo "GH_DOMAIN=${{ secrets.GH_DOMAIN_TEST }}" >> $GITHUB_ENV
          echo "ACTIVE_ENV=TEST" >> $GITHUB_ENV
        
      - name: Login Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep File
        uses: azure/arm-deploy@v1
        id: deploy_main_bicep
        with:
          subscriptionId: ${{ fromJSON(secrets.AZURE_CREDENTIALS)['subscriptionId'] }}
          resourceGroupName: ${{ secrets.AZURE_RG }}
          template: ./.bicep/logicapps/main.bicep
          parameters: env=${{ env.ACTIVE_ENV }} LAManageIdentityName=${{ secrets.LOGIC_APP_MANAGE_IDENTITY}}
          failOnStdErr: false
          scope: resourcegroup

      - name: Setup Workflow Parameters
        uses: microsoft/variable-substitution@v1 
        with:
          files: './workflows/parameters.json'
        env:
          GHMgmDomain.value: ${{ env.GH_DOMAIN }}
          
      - name: Upload Logic App Workflows
        uses: azure/CLI@v1
        with:
          azcliversion: 2.44.1
          inlineScript: |
            chmod +x ./upload_workflows.sh
            ./upload_workflows.sh ${{steps.deploy_main_bicep.outputs.accountName}} ${{steps.deploy_main_bicep.outputs.destination}}

      - name: Deploy Connection Bicep File
        uses: azure/arm-deploy@v1
        id: deploy_connection_bicep
        with:
          subscriptionId: ${{ fromJSON(secrets.AZURE_CREDENTIALS)['subscriptionId'] }}
          resourceGroupName: ${{ secrets.AZURE_RG }}
          template: ./connection.bicep
          parameters: env=${{ env.ACTIVE_ENV }} storageAccountName=${{steps.deploy_main_bicep.outputs.accountName}} principalId=${{ fromJSON(secrets.AZURE_CREDENTIALS)['clientId'] }} tenantId=${{ fromJSON(secrets.AZURE_CREDENTIALS)['tenantId'] }}
          failOnStdErr: false
          scope: resourcegroup

      - name: Deploy connection to storage file system
        shell: pwsh
        run: |
          ./deploy_connection.ps1 `
            New-WorkflowConnection `
              -ResourceGroup ${{secrets.AZURE_RG}} `
              -StorageAccount ${{steps.deploy_main_bicep.outputs.accountName}} `
              -Api ${{steps.deploy_connection_bicep.outputs.api}} `
              -Id ${{steps.deploy_connection_bicep.outputs.id}} `
              -RuntimeUrl ${{steps.deploy_connection_bicep.outputs.connectionRuntimeUrl}}