{{ define "content" }}


<div id="pageTitle"> Guidance</div>
<div x-data="data()" x-init="onLoad()">
    <form onsubmit="event.preventDefault()" autocomplete="off">
        <fieldset x-bind:disabled="mode=='view'">
            <div class="flex flex flex-col md:flex-row ">
                <div class="basis-1/2 md:base-full  md:flex-row mx-3">
                    <div class="flex flex-col  ">
                        <div>
                            <h3 class="text-lg font-medium leading-6 text-gray-900">Category</h3>
                        </div>
                        <span class="pl-1 text-xs">(Please press Enter to insert Category)</span>
                        <div>
                            <div x-data="combobox({
                                    ajax: getCategories,
                                    id : 'Id',
                                    text : 'Name',
                                    isInsertable : true,
                                  
                                    searchTag : null,
                                    searchPlaceholder : null
                                 
                                })" x-modelable="selected" x-model="form.CategoryNames">
                                <div x-html="template"></div>
                            </div>
                        </div>
                        <!-- <div> <input type="text" name="category" id="category" x-model="form.CategoryName"
                                maxlength="50"  
                                class="mt-1 focus:ring-orange-500 focus:border-orange-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border-2">

                        </div>  -->

                    </div>
                    <div>
                        <h3 class="text-lg font-medium leading-6 text-gray-900"> <br> </h3>
                    </div>
                </div>
            </div>
            <div class="flex flex flex-col md:flex-row  my-3 ">
                <div class="basis-1/2 md:base-full  md:flex-row   mx-3">
                    <div class="flex flex-col ">
                        <h3 class="text-lg font-medium leading-6 text-gray-900">Articles</h3>
                    </div>
                </div>
                <div class="basis-1/2">
                </div>
            </div>

            <div class="flex flex flex-col md:flex-row  my-3 ">
                <div class="basis-1/4 md:base-full  md:flex-row   mx-3 ">
                    <div class="flex flex-col pl-2">
                        Name
                    </div>
                </div>

                <div class="basis-9/12 md:base-full  md:flex-row   mx-3  ">
                    <div> <input type="text" name="category" id="category" x-model="form.name" maxlength="50"
                            class="mt-1 focus:ring-orange-500 focus:border-orange-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border-2">
                    </div>
                </div>
            </div>
            <div class="flex flex flex-col md:flex-row  my-3 ">
                <div class="basis-1/4 md:base-full  md:flex-row   mx-3 ">
                    <div class="flex flex-col pl-2">
                        Url
                    </div>
                </div>

                <div class="basis-9/12 md:base-full  md:flex-row   mx-3  ">
                    <div> <input type="text" name="category" id="category" x-model="form.url" maxlength="100"
                            class="mt-1 focus:ring-orange-500 focus:border-orange-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border-2">
                        <p class="text-black-500">Please add http:// or https:// to the URL</p>
                    </div>
                </div>
            </div>
            <div class="flex flex flex-col md:flex-row  my-3 ">
                <div class="basis-1/4 md:base-full  md:flex-row   mx-3 ">
                    <div class="flex flex-col pl-2">
                        Body
                    </div>
                </div>

                <div class="basis-9/12 md:base-full  md:flex-row   mx-3  ">
                    <div> <textarea type="text" name="category" id="category" x-model="form.body" maxlength="2000"
                            class="mt-1 focus:ring-orange-500 focus:border-orange-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md border-2">
                            </textarea>
                    </div>
                </div>
            </div>
        </fieldset>
        <div>
            <div align="right">
                <div x-show="form.id">
                    <button type="button" x-show="mode=='view'"
                        class="bg-orange-500  inline-flex justify-center py-2 px-4 rounded-md text-white"
                        @click="mode='edit'">

                        Edit Article

                    </button>
                </div>
                <div x-show="form.id">
                    <button type="button" x-show="mode!='view'"
                        class="bg-orange-500  inline-flex justify-center py-2 px-4 rounded-md text-white"
                        @click="submit()">

                        <span x-show="form.id">Update Article</span>

                    </button>

                    <span x-show="form.id">
                        <button type="button" x-show="mode=='edit'"
                            class="bg-orange-500  inline-flex justify-center py-2 px-4 rounded-md text-white"
                            @click="onLoad()">
                            <span x-show="form.id">Cancel</span>

                        </button>
                    </span>
                </div>
            </div>
        </div>


    </form>
</div>

<script src="/public/components/clsDropdown.js"></script>
<script src="/public/components/combobox.js"></script>
<script type="text/javascript">
    function data() {
        return {
            mode: 'view',

            form: {
                id: '{{.Id}}',
                name: '',
                names: [],
                url: '',
                body: '',
                categoryId: 0,
                CategoryName: '',
                CategoryNames: [],
                categoryArticles: []
            },
            categoryArticle: {
                id: '{{.Id}}',
                name: '',
                url: '',
                body: '',
                categoryId: 0,
                CategoryName: ''
            },
            submit() {
                var modal = Alpine.store('master').modal
                // modal.update('loading', 'Saving', 'Please wait.', '', '')
                if (!this.form.id) {
                    this.form.id = 0

                }

                this.form.categoryArticles.push(this.categoryArticle)
                this.form.CategoryName = this.form.CategoryNames[0]["text"].toString()
                this.form.categoryId = Number(this.form.CategoryNames[0]["id"].toString())

                const data = this.form;

                Alpine.store('master').putData(`/api/articles/${id}`, data,
                    "Your category has been created.",
                    "Go to category list", "/guidance")

            },

            get isValid() {
                if (
                    (this.form.name

                    )) {
                    return true
                } else {
                    return false
                }
            },
            getCategoryArticlesById(id) {

                fetch(`/api/categories/${id}/articles`)
                    .then(r => {
                        r.json().then(body => {
                            this.categoryArticle = body


                        })
                    })

            },
            async onLoad() {
                var modal = Alpine.store('master').modal
                modal.update('loading', 'Loading', 'Please wait', '', '')
                if (this.form.id) {
                    this.mode = 'view'

                    await fetch(`/api/articles/${this.form.id}`)
                        .then(r => {
                            r.json().then(body => {
                                this.form.id = body[0]["Id"]
                                this.form.name = body[0]["Name"]
                                this.form.url = body[0]["URL"]
                                this.form.body = body[0]["Body"]
                                this.form.CategoryName = body[0]["CategoryName"]
                                this.form.categoryId = body[0]["CategoryId"]

                                this.form.CategoryNames.push({
                                    id: this.form.id,
                                    text: this.form.CategoryName
                                })

                            })
                        }).catch(e => {
                            console.log(e)

                        })

                    modal.visible = false
                } else {
                    this.mode = 'edit'
                }
            }
        }
    }
    async function getCategories() {

        const res = await fetch('/api/categories')

        const data = await res.json()
        return data


    }
</script>
{{ end }}